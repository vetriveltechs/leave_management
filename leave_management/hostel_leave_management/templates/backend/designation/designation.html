{% extends "backend/base/base.html" %}

{% block title %}Designation | My Website{% endblock %}

{% block content %}
{% load static %}



<div class="modal fade" id="importPopup" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header" --style="background: #166fff;color: #fff;font-size:16px;">
				<h4 class="modal-title" id="exampleModalLabel" style="font-weight:800;font-size:16px;">Import Category</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form id="designationImportForm" enctype="multipart/form-data">
                {% csrf_token %}
				<div class="modal-body">
					<p style="font-size:14px;">Use this tool to import multiple category in one go</p>
					<div class="download-sample">
						<div class="upload-img">
							<img src="{% static 'uploads/download-csv.png' %}" class="import-icon-img">
						</div>
						<div class="download-content py-0">
							<h5><b>Step 1. Download the sample CSV template file to import</b></h5>
							<p>Click Download, if you want sample CSV template file. The first line in sample csv file should remain as it is. Please do not change the order of columns and Update valid data..</p>
							<a href="{% static 'assets/excel_files/designation.csv' %}" class="download-sample-csv pull-right" title="Download Sample File">
								<i class="fa fa-download"></i> Download
							</a>
						</div>
					</div>
					<div class="download-sample">
						<div class="upload-img">
							<img src="{% static 'uploads/upload-csv.png' %}" class="import-icon-img">
						</div>
						<div class="download-content py-0">
							<h5><b>Step 2. Upload your category</b></h5>
							<p>Add or edit your category info in the CSV file, Making sure you  dont't add or remove columns. Once your CSV file is ready to go, upload it here</p>
							
							<div class="form-group col-md-9 mb-0 p-0">
								<input type="file" name="csv"  id="chooseFile" class="form-control import-sample-csv-file singleDocument" onchange="return validateSingleDocumentExtension(this)" required />
								<span style="color:#a0a0a0;">Note : Upload format CSV and upload size is 5 mb.</span>
							</div>
						</div>
					</div>
					<div class="well well-small d-none">
						The correct column order is <span class="text-info-"> ( Category Name, Category Description and Sequence No )</span>&nbsp; &amp; You must follow this.
					</div>
					
				
					<script>
						/** Single Document Type & Size Validation **/
						function validateSingleDocumentExtension(fld) 
						{
							var fileUpload = fld;
							
							if (typeof (fileUpload.files) != "undefined")
							{
								var size = parseFloat( fileUpload.files[0].size / 1024 ).toFixed(2);
								var validSize = 1024 * 5; //1024 - 1Mb multiply 4mb
								
								//var validSize = 500; 
								
								if( size > validSize )
								{
									//alert("Document upload size is 4 MB");
									alert("File size should not exceed 5 MB.");
									$('.singleDocument').val('');
									var value = 1;
									return false;
								}
								else if(!/(\.csv)$/i.test(fld.value))
								//else if(!/(\.pdf)$/i.test(fld.value))
								{
									alert("Invalid document file type.");      
									$('.singleDocument').val('');
									return false;   
								}
								
								if(value != 1)	
									return true; 
							}
						}
					</script>
				</div>
				<div class="modal-footer">
					<!-- <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">Close</button> -->
					<button type="submit" class="btn btn-primary btn-sm ml-1">Import</button>
				</div>
			</form>
		</div>
	</div>
</div>	

<div class="content">
    <div class="card">
        <div class="card-body">
            <!-- Designation Form -->

            <form id="designationForm" method="POST">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-6">
                        <input type="hidden" id="designation_id" name="designation_id">
                        <h4 class="card-title" id="page_title"><b>Create Designation</b></h4>
                    </div>
                    <div class="col-md-6 text-right float-right">
                        <a href="#" data-toggle="modal" data-target="#importPopup" title="Import" class="btn btn-warning btn-sm">
                            Import Category
                        </a>
                    </div>
                </div>
                <fieldset>
                    <section class="header-section">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-md-4 text-right">
                                        <label class="col-form-label designation_name">Designation Name</label>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" id="designation_name" name="designation_name" autocomplete="off" class="form-control" placeholder="Designation Name">
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-4 text-right">
                                        <label class="col-form-label">Description</label>
                                    </div>
                                    <div class="col-md-6">
                                        <textarea name="description" id="description" rows="1" autocomplete="off" class="form-control" placeholder="Description"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </fieldset>

                <div class="col-md-12 mt-3 text-right">
                    <button type="submit" name="save_btn" id="save_btn" onclick="return saveBtn('save_btn');" title="Save & Continue" class="btn btn-primary btn-sm form_submit_valid">Save</button>
                    
                    <button type="reset" id="reset_btn" class="btn btn-default btn-sm">Reset</button>
                </div>
            </form>

            <script>
                function saveBtn(val) {
                    var designation_name = $("#designation_name").val();

                    if (designation_name.trim() !== "") {
                        $(".designation_name").removeClass('errorClass');
                        return true;
                    } else {
                        if (designation_name.trim() === "") {
                            $(".designation_name").addClass('errorClass');
                        } else {
                            $(".designation_name").removeClass('errorClass');
                        }

                        return false;
                    }
                }
            </script>

            <hr>
            <div class="row">
                <div class="col-md-6">
                    <h4 class="card-title"><b>Designations</b></h4>
                </div>
            </div>
            <!-- Search Section -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="row">
                        <label class="col-form-label col-md-5"><span class="text-danger">*</span> Designation Name</label>
                        <div class="form-group col-md-7">
                            <input type="text" id="search_designation_name" class="form-control searchDropdown" placeholder="Designation Name">   
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="row">
                        <label class="col-form-label col-md-5"><span class="text-danger">*</span> Status</label>
                        <div class="form-group col-md-7">
                            <select id="active_flag" class="form-control searchDropdown">
                                {% for row in activeFlag %}
                                    <option value="{{ row.list_code }}">{{ row.list_value|capfirst }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <a href="{% url 'designation-form' %}" title="Clear" class="btn btn-default">Clear</a>
                </div>
            </div>

            <div class="row pb-3">
                <div class="col-md-6">
                    <div id="exportButtons" class="mb-2" style="display:none;">
                        <button class="btn btn-sm btn-outline-primary" onclick="exportRecords('csv','Designations')">Export CSV</button>
                        <button class="btn btn-sm btn-outline-success" onclick="exportRecords('excel','Designations')">Export Excel</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="exportRecords('pdf','Designations')">Export PDF</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="printDesignations('Designations')">Print</button>
                    </div>

                </div>
                <div class="col-md-6 text-right float-right">
                    <label>Show 
                        <select id="pageSize" class="form-control form-control-sm" style="width:auto; display:inline-block;">
                            <option value="5" selected>5</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                        </select>
                    </label>
                </div>
            </div>

            <!-- Table -->
            <table class="table table-bordered table-hover line_items" id="line_items">
                <thead>
                    <tr>
                        <th class="tab-md-200">Controls</th>
                        <th class="tab-md-200">Designation Name</th>
                        <th class="tab-md-200">Description</th>
                        <th class="tab-md-200 text-center">Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div class="row mb-2">
                <div class="col-md-6"></div>
                <div class="col-md-6 text-right">
                    <div id="pagination"></div>
                </div>
            </div>

            <div id="response" class="mt-3"></div>
        </div>
    </div>
</div>
<script src="{% static 'assets/backend/assets/js/designation/designation.js' %}"></script>



<!-- <script>
    // === GLOBAL VARIABLES ===
    let allDesignations = [];
    let filteredDesignations = [];
    let currentPage = 1;
    let pageSize = 5;

    // === LOAD DESIGNATIONS ===
    function loadDesignations() {
        $.ajax({
            url: '/api/designations/',
            type: 'GET',
            success: function(response) {
                allDesignations = response;
                filteredDesignations = [...allDesignations];
                renderTable();
            },
            error: function() {
                $('#response').html('<p style="color:red;">Error loading designations.</p>');
            }
        });
    }

    // === FILTER DESIGNATIONS ===
    function filterDesignations() {
        const searchName    = $('#search_designation_name').val().toLowerCase();
        const searchStatus  = $('#active_flag').val();

        filteredDesignations = allDesignations.filter(function(item){
            let matchesName = item.designation_name.toLowerCase().includes(searchName);
            let matchesStatus = searchStatus === "ALL" || item.active_flag === searchStatus;
            return matchesName && matchesStatus;
        });

        currentPage = 1;
        renderTable();
    }

    // === RENDER TABLE ===
    function renderTable() {
        let total = filteredDesignations.length;
        let totalPages = Math.ceil(total / pageSize) || 1;
        if(currentPage > totalPages) currentPage = totalPages;

        let start = (currentPage - 1) * pageSize;
        let end = start + pageSize;
        let pageData = filteredDesignations.slice(start, end);

        $('#line_items tbody').empty();

        if(pageData.length > 0){
            pageData.forEach(function(item){
                let newRow = $('<tr class="remove_tr tabRow">');
                let cols = "<td>"
                    + "<div class='dropdown'>"
                    + "<button type='button' class='btn btn-outline-info dropdown-toggle btn-sm' data-toggle='dropdown' aria-expanded='false'>"
                    + "Action<i class='fa fa-chevron-down'></i>"
                    + "</button>"
                    + "<ul class='dropdown-menu dropdown-menu-right dropdown-menu-new'>"
                    + "<li><a href='javascript:void(0);' onclick='editDesignation(" + item.designation_id + ")'><i class='fa fa-pencil'></i> Edit</a></li>"
                    + "<li><a href='javascript:void(0);' onclick='viewDesignation(" + item.designation_id + ")'><i class='fa fa-eye'></i> View</a></li>"
                    + "<li>" + (item.active_flag === 'Y'
                        ? "<a href='javascript:void(0);' onclick='toggleStatus(" + item.designation_id + ", \"N\")' title='Inactive'><i class='fa fa-ban'></i> Inactive</a>"
                        : "<a href='javascript:void(0);' onclick='toggleStatus(" + item.designation_id + ", \"Y\")' title='Active'><i class='fa fa-check'></i> Active</a>") + "</li>"
                    + "</ul>"
                    + "</div>"
                    + "</td>";

                cols += "<td>" + item.designation_name + "</td>";
                cols += "<td>" + item.description + "</td>";
                cols += "<td class='text-center'>" + (item.active_flag === 'Y'
                    ? "<span class='btn btn-outline-success btn-sm' title='Active'>Active</span>"
                    : "<span class='btn btn-outline-warning btn-sm' title='Inactive'>Inactive</span>") + "</td>";

                newRow.append(cols);
                $('#line_items tbody').append(newRow);
            });
        } else {
            $('#line_items tbody').append('<tr><td colspan="4" class="text-center">No records found</td></tr>');
        }

        renderPagination(totalPages, currentPage);
    }

    // === SMART PAGINATION ===
    function renderPagination(totalPages, currentPage) {
        if(totalPages <= 1) {
            $('#pagination').empty();
            return;
        }

        let pagHtml = '<nav><ul class="pagination pagination-sm justify-content-end">';

        // First & Prev
        pagHtml += `<li class="page-item ${currentPage === 1 ? 'disabled':''}">
                        <a href="#" class="page-link page-first">First</a>
                    </li>`;
        pagHtml += `<li class="page-item ${currentPage === 1 ? 'disabled':''}">
                        <a href="#" class="page-link page-prev">Prev</a>
                    </li>`;

        let start = Math.max(1, currentPage - 2);
        let end = Math.min(totalPages, currentPage + 2);

        if(start > 1){
            pagHtml += `<li class="page-item"><a href="#" class="page-link page-num" data-page="1">1</a></li>`;
            if(start > 2){
                pagHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        for(let i = start; i <= end; i++){
            pagHtml += `<li class="page-item ${i===currentPage ? 'active':''}">
                            <a href="#" class="page-link page-num" data-page="${i}">${i}</a>
                        </li>`;
        }

        if(end < totalPages){
            if(end < totalPages - 1){
                pagHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            pagHtml += `<li class="page-item"><a href="#" class="page-link page-num" data-page="${totalPages}">${totalPages}</a></li>`;
        }

        // Next & Last
        pagHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled':''}">
                        <a href="#" class="page-link page-next">Next</a>
                    </li>`;
        pagHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled':''}">
                        <a href="#" class="page-link page-last">Last</a>
                    </li>`;

        pagHtml += '</ul></nav>';
        $('#pagination').html(pagHtml);
    }

    // === PAGINATION EVENTS ===
    $(document).on('click', '.page-num', function(e){
        e.preventDefault();
        currentPage = parseInt($(this).data('page'));
        renderTable();
    });

    $(document).on('click', '.page-prev', function(e){
        e.preventDefault();
        if(currentPage > 1){
            currentPage--;
            renderTable();
        }
    });

    $(document).on('click', '.page-next', function(e){
        e.preventDefault();
        let totalPages = Math.ceil(filteredDesignations.length / pageSize);
        if(currentPage < totalPages){
            currentPage++;
            renderTable();
        }
    });

    $(document).on('click', '.page-first', function(e){
        e.preventDefault();
        currentPage = 1;
        renderTable();
    });

    $(document).on('click', '.page-last', function(e){
        e.preventDefault();
        let totalPages = Math.ceil(filteredDesignations.length / pageSize);
        currentPage = totalPages;
        renderTable();
    });

    // === PAGE SIZE CHANGE ===
    $('#pageSize').on('change', function(){
        pageSize = parseInt($(this).val());
        currentPage = 1;
        renderTable();
    });

    // === SEARCH INPUT EVENTS ===
    $('#search_designation_name, #active_flag').on('input change', function(){
        filterDesignations();
    });

    // === FORM SUBMIT ===
    $('#designationForm').on('submit', function(e){
        e.preventDefault();
        let id = $('#designation_id').val();
        let url = '/api/designations/';
        let type = 'POST';
        if(id){
            url += id + '/';
            type = 'PUT';
        }

        $.ajax({
            url: url,
            type: type,
            headers: { 'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(), 'Content-Type': 'application/json' },
            data: JSON.stringify({
                designation_name: $('#designation_name').val(),
                description: $('#description').val()
            }),
            success: function() {
                $('#response').html('<p style="color:green;">Designation saved successfully!</p>');
                $('#designationForm')[0].reset();
                $('#designation_id').val('');
                $('#designation_name, #description').prop('disabled', false);
                $('#save_btn').show();
                loadDesignations();
            },
            error: function() {
                $('#response').html('<p style="color:red;">Error saving designation.</p>');
            }
        });
    });

    // === INITIAL LOAD ===
    $(document).ready(function(){
        pageSize = parseInt($('#pageSize').val());
        loadDesignations();
    });

    // === EDIT ===
    function editDesignation(id){
        $.ajax({
            url: '/api/designations/' + id + '/',
            type: 'GET',
            success: function(data){
                $('#page_title').html('<b>Edit Designation</b>');
                $('#designation_id').val(data.designation_id);
                $('#designation_name').val(data.designation_name).prop('disabled', false);
                $('#description').val(data.description).prop('disabled', false);
                $('#save_btn').show();
            },
            error: function(){
                $('#response').html('<p style="color:red;">Error fetching designation.</p>');
            }
        });
    }

    // === VIEW ===
    function viewDesignation(id){
        $.ajax({
            url: '/api/designations/' + id + '/',
            type: 'GET',
            success: function(data){
                $('#page_title').html('<b>Edit Designation</b>');
                $('#designation_id').val(data.designation_id);
                $('#designation_name').val(data.designation_name).prop('disabled', true);
                $('#description').val(data.description).prop('disabled', true);
                $('#save_btn').hide();
            },
            error: function(){
                $('#response').html('<p style="color:red;">Error fetching designation.</p>');
            }
        });
    }

    // === TOGGLE STATUS ===
    function toggleStatus(id, newStatus) {
        $.ajax({
            url: '/api/designations/' + id + '/',
            type: 'PATCH',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({ active_flag: newStatus }),
            success: function(data) {
                let designation = allDesignations.find(d => d.designation_id === id);
                if(designation) designation.active_flag = newStatus;
                filterDesignations();
            },
            error: function() {
                $('#response').html('<p style="color:red;">Error updating status.</p>');
            }
        });
    }

    function formatDate(dateStr) {
        if (!dateStr) return "";
        let d = new Date(dateStr);
        if (isNaN(d)) return ""; // invalid date
        return d.toLocaleDateString("en-GB", {
            day: "2-digit",
            month: "short",
            year: "numeric"
        }).replace(/ /g, "-"); // e.g. 22-Dec-2025
    }
</script>



<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
function exportData(type) {
    let exportData = filteredDesignations.map((item, index) => ({
        "S.No": index + 1,
        "Designation Name": item.designation_name || "",
        "Description": item.description || "",
        "Status": item.active_flag === 'Y' ? 'Active' : 'Inactive',
        "Created Date": formatDate(item.created_date)
    }));

    if (type === "csv" || type === "excel") {
        let ws = XLSX.utils.json_to_sheet(exportData);
        let wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Designations");

        if (type === "csv") {
            XLSX.writeFile(wb, "designations.csv", { bookType: "csv" });
        } else {
            XLSX.writeFile(wb, "designations.xlsx", { bookType: "xlsx" });
        }
    }

    if (type === "pdf") {
        const { jsPDF } = window.jspdf;
        let doc = new jsPDF();
        doc.autoTable({
            head: [["S.No", "Designation Name", "Description", "Status", "Created Date"]],
            body: exportData.map(row => [
                row["S.No"], row["Designation Name"], row["Description"], row["Status"], row["Created Date"]
            ])
        });
        doc.save("designations.pdf");
    }
}

// === Print Function ===
function printData() {
    let exportData = filteredDesignations.map((item, index) => ({
        "S.No": index + 1,
        "Designation Name": item.designation_name || "",
        "Description": item.description || "",
        "Status": item.active_flag === 'Y' ? 'Active' : 'Inactive',
        "Created Date": formatDate(item.created_date)
    }));

    let newWin = window.open("");
    newWin.document.write("<html><head><title>Print</title></head><body>");
    newWin.document.write("<h3>Designations</h3>");
    newWin.document.write("<table border='1' cellspacing='0' cellpadding='5'><thead><tr><th>S.No</th><th>Designation Name</th><th>Description</th><th>Status</th><th>Created Date</th></tr></thead><tbody>");
    exportData.forEach(row => {
        newWin.document.write(`<tr>
            <td>${row["S.No"]}</td>
            <td>${row["Designation Name"]}</td>
            <td>${row["Description"]}</td>
            <td>${row["Status"]}</td>
            <td>${row["Created Date"]}</td>
        </tr>`);
    });
    newWin.document.write("</tbody></table>");
    newWin.document.write("</body></html>");
    newWin.document.close();
    newWin.print();
}
</script>
 -->

{% endblock %}
